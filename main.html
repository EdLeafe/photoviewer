<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Cache-control" content="public">
  <style>
    html, body {
      margin: 0;
      height: 100%;
      background-color: #000000;
      cursor: url(data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7), auto;
    }
    .imgcontainer {
      width: 100%;
      height: 100%;
    }
    .display {
      width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
  </style>
  <script type="text/javascript">
    var port = "9001" ;

    function timeString() {
        // Returns the current time with a trailing space
        d = new Date();
        return d.toTimeString().slice(0,9);
    }

    function logit(msg) {
        console.log(timeString() + msg);
    }

    function reloadImage() {
      var now = new Date();
      var img = document.getElementById("display");
      logit("Reloading; image.src: " + img.src);
      var main_src = img.src.split("?")[0];
      img.src = main_src + "?" + now.getTime();
      logit("Reloaded; new image: " + img.src);
      // new timeout: 5 min.
      // setTimeout("reloadImage()", 5 * 60 * 1000);
    }

    function reloadFirst() {
        logit("First reload");
        reloadImage();
    }

    function reloadSecond() {
        logit("Second reload");
        reloadImage();
    }

    async function setNewImage(url, refresh = false) {
      img = document.getElementById("display");
      logit("Current image src = " + img.src);
      if (refresh === true && url === img.src) {
        logit("Same image; not changing display");
        return;
      }
      logit("New src: " + url);
      img = document.getElementById("display");
      img.src = url;
      if (refresh) {
        await sleep(1000);
        await setNewImage(url, refresh = false) ;
      }

      logit("Setting reload timeouts");
      // Force a refresh after 5 seconds, 30 seconds, and 2 minutes
      // setTimeout("reloadFirst()", 5000);
      // setTimeout("reloadSecond()", 30000);
      setTimeout("reloadImage()", 10000);
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function fetchURL() {
      while (true) {
        logit("Starting fetch");
        await fetch("http://localhost:" + port + "/status")
          .then(function(response) {
            return response.text();
          }
        )
        .then(function(data) {
          logit("New URL: " + data);
          setNewImage(data);
          }
        );
      }
    }

    async function connectToPhotoServer() {
      while (true) {
        try {
          await fetchURL();
        } catch(err) {
          logit("PhotoServer not available; sleeping 5 seconds. Error: " + err);
          await sleep(5000);
        }
      }
    }


  </script>
</head>
<body onload="connectToPhotoServer();">
<div class="imgcontainer">
  <img class="display" id="display" src="" alt="display"/>
</div>
</body>
</html>
